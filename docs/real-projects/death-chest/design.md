# DC-1 项目简介与设计

## 背景与动机

在 Minecraft 中，当玩家死亡时，如果 `keepInventory`（即保留物品栏）规则没有开启，那么玩家的物品将会掉落在附近的地上。

这个机制虽然看上去很直观，但其实从游戏设计的角度来说并不算优秀。找回遗失的物品的确增加了游戏的挑战性，但如果物品掉落在岩浆或者虚空中，对玩家造成的挫败感非常大 —— 特别是如果玩家拥有很多优质装备的时候。在多人游戏中，如果玩家死亡就会掉落装备，并且还能被其他人获取的话，也许就会与大多数生存服务器“共同发展”的初衷而违背……当然，这些很大程度上是主观观点，我们也不打算在此搬出专业的游戏设计理论。不过，我们想通过插件来改变这一机制，创造一种**更安全地保留掉落物**的方法，以便于玩家稍后取回这些物品。

参考游戏《Apex Legends》中的死亡之箱设定，我们可以把相同的机制在 Minecraft 中实现：当玩家死亡时，会在其死亡位置附近生成一个箱子，包含玩家的全部物品。玩家、队友或者敌人可以与其互动获取这些物品。

## 功能设计

### 设想与问题

有了这个设想，我们就能初步写出插件的设计方案：

> **死亡之箱（Drop Chest）**
>
> 当玩家死亡时，取代原先的掉落物机制，改为在死亡位置生成一个箱子，包含玩家的掉落物。玩家或其他人可以访问这些物品。

*由于 Spigot 上已经有名为 Death Chest 的同名插件了，为了避免名称的冲突，我们就改用 Drop 一词，表示“装着掉落物的箱子”。*

> Nyaci：诶，这次你怎么没有像之前那样把细节都搬出来？怎么只有一行概述呢？

对插件功能的**细化**是很重要的，在设计插件的时候，常常会有一些没有考虑到的情况，导致预想中的机制被用在奇怪的地方。虽然 Minecraft 玩家对于把 bug 当作“特性”已经习以为常了，但我们不能用玩家的宽容去掩盖设计中的失误，因此**防止功能滥用**就非常重要。

先前，处理插件功能的细节是由笔者直接完成的，大家可能还不了解怎么发现插件功能中的问题。的确，Minecraft 本身有很多很复杂的机制，因此一个功能是否会被用在意料之外的地方，需要相当多的游戏经验。笔者在这里给大家总结一条口诀，它能排除大约 80% 的功能细节问题：

:::tip 防止功能滥用的口诀

“用法用量须牢记，效果影响须明细，无中生有须警惕。”

:::

这实际上对应着三条原则：

- **用法的考虑需要全面**：当修改游戏机制时，要全面考察该机制的用途。**一个游戏机制的用途很很可能比你想象得还要多**。
  
  例如，铁砧可以防爆，但也可以用来砸人，如果你计划让铁砧能被黏性活塞拉动，就必须考虑是否会影响到二者之一。

- **效果的影响尽量减少**：尽可能少赋予高等级、影响大的效果，而尝试使用低等级、影响小的效果。**如果你的功能影响范围小，它们就更难被滥用**。

  例如，让玩家一次性减免伤害，可以不使用抗性提升效果，而改为直接在对应的事件中修改伤害量。

- **发放的资源应当回收**：除特殊情况外，由插件发放的任何资源（物品、权限、效果等）都应当有对应的回收机制。**资源要避免无中生有**。

  例如，在死亡之箱插件里，如果生成的箱子不予回收，玩家就可以通过反复死亡刷取箱子，这可能不是你所期望的。

### 防止功能的滥用

根据这几条原则，我们来审视一下这个插件的功能：

- “在玩家死亡时”：玩家死亡是一个相当宽泛的事件。是任何原因死亡都要生成死亡之箱吗？死亡时在任何状态下都要生成死亡之箱吗？

  也许并不是在任何情况下都要生成箱子。箱子的目的是包含死亡玩家的物品，因此如果没有这样的物品，就不需要生成。所以：

    - 如果 `keepInventory` 规则打开，则不需要生成死亡之箱。
    - 如果死亡时玩家物品栏内没有任何物品，则不需要生成死亡之箱。

- “在死亡位置生成箱子”：要生成什么箱子？箱子足以容纳掉落物吗？该位置能生成箱子吗？生成箱子的位置便于玩家前往吗？

  死亡之箱的目的是装下玩家的掉落物，并且方便玩家拿取。我们当然可以直接创造一个真正的箱子放在那里，但如果玩家掉落超过 54 组物品（例如背包插件的影响），那么箱子可能放不下。此外，箱子本身是一个功能丰富的方块，它可以与漏斗交互，能与其它箱子拼接，要妥善处理这些机制也非常困难。换句话说，**生成一个箱子的影响是很大的**，我们想要减小这种影响。

  既然使用真正的箱子过于麻烦，我们可以换一种思路，即不要真的生成一个箱子，而是放一个“假箱子”在那里，当玩家与之交互的时候，就把其中的物品加入玩家的物品栏，并立即删除死亡之箱。这样我们的实体也不再不局限于箱子，因此可以使用其它方块，例如信标或者旗帜。

  除了是否生成真正的箱子之外，我们还需要考虑死亡之箱生成的位置。我们希望玩家能比“靠近拾起掉落物”更方便地获取死亡时的物品，因此死亡之箱**不应该出现在很难到达的地方**。例如，如果玩家被岩浆烧死，我们不希望把箱子生成在岩浆里，而如果玩家坠入虚空，要在世界之外生成一个箱子更是不可能。
  
  考虑到这些因素，我们要在玩家死亡的位置附近找一个合适的位置放置箱子。究竟怎样才算合适？这可以稍后再考虑。

  此外，生成的方块还需要**妥善回收**。在大多数情况下，玩家在死亡后只要去取回物品，死亡之箱就会消失。但是，如果玩家重生在很远的地方，再也不来拿了会如何？如果玩家被封禁或者出于某些原因不再游玩服务器，这些生成的箱子如何处理？
  
  我们可以选择让它们在一段时间后自动“分解”并掉落其中的物品，也可以选择允许其他人拿取，因为只要服务器上还有玩家游玩，从概率角度上来说，无人问津的死亡之箱迟早会被人“自然地”发现并取走。在这里，我们采取第一种方式，因为当物品掉落后，其他人自然可以来捡走，而如果一直没人来处理这些物品，它们最终会被游戏删除。

  综上所述，关于死亡之箱生成的相关功能细节就可以写出来了：

  - 玩家死亡时生成一个特定方块，与该方块交互即可取回物品，同时该方块会消失。
  - 死亡之箱生成在附近合适的位置。
  - 死亡之箱会在一段时间后自然分解，物品掉落在地上。

- “玩家或其他人可以访问这些物品”：什么情况下可以访问？玩家和其他人的访问方式一样吗？

  这里的分析需要用到一点点游戏设计的思维，不过并不算难。

  首先要明确的是，在 Minecraft 中，物品是没有所有者的 —— 一个物品位于某个玩家的物品栏中，不代表它属于该玩家。不过，在大多数 Minecraft 服务器中，物品的所有权很重要，所以会有箱子锁之类的插件防止坏人盗取物品。从游戏设计的角度，玩家获取一件高价值物品（例如满配附魔的剑）是很困难的，如果其他人想要获取这些物品，就**必须支付相近的代价**。

  在本例中，如果死亡之箱任何人都可以随意访问，那么相当于只需要设法击杀玩家（例如使用陷阱，或者干脆直接动手），就可以获得其物品。尽管部分服务器的游玩模式就是如此，但大多数重视秩序的服务器不提倡这样做，因此在我们的插件中，我们也需要限制所有者之外的玩家访问这些物品。当然，死亡之箱会在一段时间后分解，那时任何人都可以来获取物品。不过，在死亡之箱存在的期间，我们希望对玩家**提供一定的保护**。

  - 玩家本人可以随时访问箱子并取走其中物品。
  - 玩家可以授权其他玩家作为“朋友”，代为取走物品。授权通过命令进行，可以是永久的，也可以是一次性的。
  - 在死亡之箱存在期间，未授权的玩家无法以任何方式取得其中的物品。

总结一下，我们将插件的设计方案细化如下：

> **死亡之箱（Drop Chest）**
>
> 当玩家死亡时，取代原先的掉落物机制，改为在死亡位置生成一个箱子，包含玩家的掉落物。玩家或其他人可以访问这些物品。
>
> - 仅在有实际掉落物时才生成死亡之箱。
> - 通过与死亡之箱交互，物品将直接放入物品栏。
> - 仅有玩家本人或者通过命令授权的“朋友”可以获得其中的物品。
> - 死亡之箱会在一段时间后分解并掉落其中物品。

看看，这就和我们在第一话中做的那些设计非常相似了，对吧？现在你应该发现了，这一条条的细节背后，可不是一拍脑袋就想出来的，而必须经过缜密的分析，确保功能的每个细节都符合我们的设计。

### 在故事结束之后

通过上面的功能分析，我们已经尽可能减少了插件运行时功能被滥用的可能，但除此之外，我们还希望插件的功能是**自然消亡**的，也就是说，如果我们的插件从服务器上被卸载，我们希望**不在服务器上留下任何永久的影响**。

许多插件本来就是自然消亡的，例如背包插件，当插件删除后，对应的命令就无法使用，背包自然也就没有了。同样，有许多插件是没有必要自然消亡的，例如盔甲架调整插件，尽管插件被删除，但被修改的盔甲架依然可以留在世界中，这不会造成任何不必要的影响。

遗憾的是，我们的插件并非自然消亡的，而留下的影响也不是可忽略的：如果使用信标作为死亡之箱的媒介，那么在插件删除后，这些信标就变成普通的信标，玩家就可以获取它们。像这样，在插件功能不是自然消亡，而又有必要使其消亡的情况下，就需要做额外的处理。

由于插件被删除后就什么也做不了了，因此使插件功能自然消亡的基本方法是**关闭服务器时清除影响**，在插件“还能运行”的时候就“留下后手”。在本例中，我们会在服务器关闭时**删除**所有死亡之箱，将这些数据存放到数据库或者别的地方。下次服务器启动时，如果我们的插件还存在，我们就将死亡之箱**重新加载**到世界中。如果插件被删除，那么死亡之箱无法加载，这些影响自然也就没有了。

:::info

并非所有的插件都能像这样做到自然消亡。如果每次服务器启停都要做这样的存取操作，就会消耗额外的性能，而这样的负担并不是总能令人接受的。

在本例中，由于玩家的数目相对于世界中实体的数目很小，因此存取死亡之箱几乎不影响服务器的性能。但如果你像机械动力模组那样设计“高级活塞”，那么玩家可能会在世界中摆成千上万个活塞，要实时存取它们根本就是不切实际的事情。

读者应当明白，插件功能的自然消亡是一种理想的性质，但**不是总能做到的**。如果无法做到自然消亡，那么就需要在文档中注明，以便于管理员妥善卸载插件。

:::

所以我们更新插件的功能：

> **死亡之箱（Drop Chest）**
>
> 当玩家死亡时，取代原先的掉落物机制，改为在死亡位置生成一个箱子，包含玩家的掉落物。玩家或其他人可以访问这些物品。
>
> - 仅在有实际掉落物时才生成死亡之箱。
> - 通过与死亡之箱交互，物品将直接放入物品栏。
> - 仅有玩家本人或者通过命令授权的“朋友”可以获得其中的物品。
> - 死亡之箱会在一段时间后分解并掉落其中物品。
> - 死亡之箱数据在启动时加载，关闭时删除，而不会永久保存在世界存档中。

## 可配置性

功能设计完成后，我们就需要开始考虑插件的可配置部分，也就是哪些部分可由配置文件更改。

在应用中，为了让插件适用于尽可能多的场合，大多数插件都是高度可配置的。不过，这并不意味着把插件的方方面面都交给管理员就是件好事 —— 如果可配置的项目过多，用户可能会填入错误的配置，而导致插件无法正常工作。例如，在这个项目里，就不能允许用户随意配置死亡之箱的类型，否则如果用户填入箱子或者木桶，那么当玩家试图用漏斗与之交互时，就会出现不可预料的问题，而这些问题如果不做单独的适配，是非常难解决的。

让功能变得可配置并不是什么难事，只要想想**哪些功能**是我们希望用户能改变的，然后把其中**由插件做出的选择**改为**允许管理员做出**就可以了。在这个插件中，我们可以这样来设计可配置的功能：

- 【物品取回模式】决定玩家取回物品时，死亡之箱的行为。
  - 【总是全部取回】总是将物品塞入玩家物品栏，并将剩下的物品掉落在玩家周围。
  - 【尽可能地取回】取出一部分物品塞入玩家物品栏，剩下的物品保留在死亡之箱中。
  - 【需要足够空间】仅在空间足够时才将所有物品塞入玩家物品栏，否则发送一条消息，提醒玩家清理物品栏空间。
- 【物品保留时间】决定死亡之箱在自然分解前保留的时间。
- 【物品自然消失】决定由死亡之箱掉落的物品是否永久保留在世界中而不自然消失。
- 【死亡之箱可破坏】决定死亡之箱本身能否被破坏，当可以被破坏时，将掉落其中的物品。

当然，这并不是配置文件的全部，一个具体的配置文件还需要能自定义向玩家发送的消息、死亡之箱的提示等等，不过这些细节性的东西不影响功能的设计，就让我们留到稍后再考虑吧。

---

这一节真是长！为了和《插件开发之旅》中一样得出一份可行的设计案，我们花了不少功夫！其实之前的插件也是有这样的步骤的，不过是由笔者代劳了而已。然而，如果不把这些技巧分享给读者，那么大家即使读了本书，也没办法把自己的创意变成现实，这可不是我们想看到的结果。

应该说，插件的功能越复杂，在着手开发之前，要做的设计就越多。本书名为《插件设计与编程》，正是想强调**设计**是与**编程**同等重要的步骤 —— 灵光一闪很容易，但要把灵感变为现实，需要绝对严谨而符合逻辑的推理和设计。“插件开发就是 1% 的灵感，49% 的设计，与 50% 的辛苦编码！”